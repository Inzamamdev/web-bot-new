<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Preview - {{ repo_name }}</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Hide scrollbars if iframe fits exactly */
        }
        #embed-container {
            width: 100vw;   /* 100% of viewport width */
            height: 100vh;  /* 100% of viewport height */
            border: none;   /* Remove default iframe border */
            display: flex;  /* Use flexbox to center content */
            justify-content: center;
            align-items: center;
        }
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: sans-serif;
            color: #333;
            font-size: 1.2em;
        }
    </style>
    <script src="https://unpkg.com/@stackblitz/sdk/bundles/sdk.umd.js"></script>
</head>
<body>
    <div id="loading-message">Loading preview...</div>
    <div id="embed-container"></div>

    <script type="text/javascript">
        // Safely pass Python dictionary to JavaScript using json_script filter
        // The json_script filter (Django >= 2.1) automatically escapes content
        // and places it inside a <script type="application/json"> tag.
        // We'll simulate this for direct copy-paste.
        const filesDataString = `{{ files_data | safe }}`; // Mark as safe because it's already JSON dumped in Django
        const filesData = JSON.parse(filesDataString);

        // Define the project configuration for Stackblitz SDK
        const project = {
            files: filesData,
            title: 'Live Preview: {{ repo_name }}',
            description: 'Generated by Telegram Bot',
            template: 'javascript', // Ensure this matches your project type (javascript, typescript, etc.)
            dependencies: {}, // No specific dependencies for vanilla HTML/CSS/JS
        };

        // Define embed options for the iframe
        const embedOptions = {
            height: '100%',
            width: '100%',
            openFile: ['index.html'], // Optional: Specifies which file to open
            view: 'preview',           // Essential: Only show the preview panel
            hideExplorer: true,        // Optional: Hide the file explorer
            hideNavigation: true,      // Optional: Hide the top navigation bar
            hideDevTools: true,        // Optional: Hide the developer tools (console, problems)
            terminalHeight: 0,         // Optional: Set terminal height to 0 to hide it
            clickToLoad: false,        // Optional: Automatically load, no click needed
        };

        // Embed the project into the 'embed-container' div
        // The project is automatically opened in a new iframe within the div
        StackBlitzSDK.embedProject(
            'embed-container', // The ID of the HTML element to embed into
            project,           // The project configuration
            embedOptions       // The embedding options
        )
        .then(() => {
            console.log('Stackblitz project embedded successfully!');
            document.getElementById('loading-message').style.display = 'none'; // Hide loading message
        })
        .catch(error => {
            console.error('Error embedding Stackblitz project:', error);
            document.getElementById('loading-message').innerText = 'Failed to load preview.';
        });
    </script>
</body>
</html>